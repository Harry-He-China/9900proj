<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.myspace.infrastructure.dao.IManuscriptCommentDao">

    <resultMap type="cn.myspace.infrastructure.po.ManuscriptComment" id="ManuscriptCommentMap">
        <result property="commentId" column="comment_id"/>
        <result property="parentCommentId" column="parent_comment_id"/>
        <result property="index" column="index"/>
        <result property="manuscriptId" column="manuscript_id"/>
        <result property="content" column="content"/>
        <result property="creator" column="creator"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <collection property="comments" ofType="cn.myspace.infrastructure.po.ManuscriptComment">
            <result property="commentId" column="child_comment_id"/>
            <result property="parentCommentId" column="child_parent_comment_id"/>
            <result property="index" column="child_index"/>
            <result property="manuscriptId" column="manuscript_id"/>
            <result property="content" column="child_content"/>
            <result property="creator" column="child_creator"/>
            <result property="createTime" column="child_create_time"/>
            <result property="updateTime" column="child_update_time"/>
        </collection>
    </resultMap>

    <!--查询单个-->
    <select id="queryByIdWithChildComment" resultMap="ManuscriptCommentMap">
        select
            mc1.comment_id,
            mc1.parent_comment_id,
            mc1.`index`,
            mc1.manuscript_id,
            mc1.content,
            mc1.creator,
            mc1.create_time,
            mc1.update_time,
            mc2.comment_id as child_comment_id,
            mc2.parent_comment_id as child_parent_comment_id,
            mc2.`index` as child_index,
            mc2.content as child_content,
            mc2.creator as child_creator,
            mc2.create_time as child_create_time,
            mc2.update_time as child_update_time
        from manuscript_comment mc1
                 join manuscript_comment mc2 on mc2.delete_mark = 0 and mc1.comment_id = mc2.parent_comment_id
        where mc1.comment_id = #{commentId}
          and mc1.delete_mark = 0
        order by mc1.parent_comment_id, mc1.`index`
    </select>

    <!--新增所有列-->
    <insert id="insert" keyProperty="commentId">
        insert into manuscript_comment(comment_id, parent_comment_id, `index`, manuscript_id, content, creator, create_time,
        update_time, delete_mark)
        values (#{commentId}, #{parentCommentId}, #{index}, #{manuscriptId}, #{content}, #{creator}, sysdate(), sysdate(), 0)
    </insert>

    <!--通过主键修改数据-->
    <update id="update">
        update manuscript_comment
        <set>
            <if test="content != null">
                content = #{content},
            </if>
                update_time = sysdate(),
            <if test="deleteMark != null">
                delete_mark = #{deleteMark},
            </if>
        </set>
        where comment_id = #{commentId}
    </update>

</mapper>