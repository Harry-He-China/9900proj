<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.myspace.infrastructure.dao.IOrderDao">

    <resultMap type="cn.myspace.infrastructure.po.Order" id="OrderMap">
        <result property="orderId" column="order_id"/>
        <result property="goodsId" column="goods_id"/>
        <result property="num" column="num"/>
        <result property="totalPrice" column="total_price"/>
        <result property="creator" column="creator"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <association property="goods" column="goods_id"
                     select="cn.myspace.infrastructure.dao.IGoodsDao.queryById"
                     javaType="cn.myspace.infrastructure.po.Goods">
        </association>
    </resultMap>

    <!--查询单个-->
    <select id="queryById" resultMap="OrderMap">
        select
        order_id, goods_id, num, total_price, creator, create_time, update_time, delete_mark
        from `order`
        where order_id = #{orderId}
          and delete_mark = 0
    </select>

    <!--通过实体作为筛选条件查询-->
    <select id="queryCount" resultType="long">
        select count(1)
        from `order`
        <where>
            <if test="o.minPrice != null and o.maxPrice != null">
                and total_price &lt;= #{o.maxPrice}
                and total_price &gt;= #{o.minPrice}
            </if>
            <if test="o.creator != null">
                and creator = #{o.creator}
            </if>
            <if test="o.startTime != null and o.endTime != null">
                and (date_format(create_time ,'%Y-%m-%d') &lt;= date_format(#{o.startTime} ,'%Y-%m-%d'))
                and (date_format(create_time ,'%Y-%m-%d') &gt;= date_format(#{o.endTime},'%Y-%m-%d'))
            </if>
            and delete_mark = 0
        </where>
    </select>

    <select id="queryAll" resultMap="OrderMap">
        select
        order_id, goods_id, num, total_price, creator, create_time, update_time
        from `order`
        <where>
            <if test="o.minPrice != null and o.maxPrice != null">
                and total_price &lt;= #{o.maxPrice}
                and total_price &gt;= #{o.minPrice}
            </if>
            <if test="o.creator != null">
                and creator = #{o.creator}
            </if>
            <if test="o.startTime != null and o.endTime != null">
                and (date_format(create_time ,'%Y-%m-%d') &lt;= date_format(#{o.startTime} ,'%Y-%m-%d'))
                and (date_format(create_time ,'%Y-%m-%d') &gt;= date_format(#{o.endTime},'%Y-%m-%d'))
            </if>
            and delete_mark = 0
            <if test="o.order != null and o.orderType != null">
                order by ${o.order} ${o.orderType}
            </if>
        </where>
        limit #{o.pageBegin}, #{o.pageEnd}
    </select>

    <!--新增所有列-->
    <insert id="insert" keyProperty="orderId" >
        insert into `order`(order_id, goods_id, num, total_price, creator, create_time, update_time, delete_mark)
        values (#{orderId}, #{goodsId}, #{num}, #{totalPrice}, #{creator}, sysdate(), sysdate(), 0)
    </insert>

    <!--通过主键修改数据-->
    <update id="update">
        update `order`
        <set>
            <if test="totalPrice != null">
                total_price = #{totalPrice},
            </if>
                update_time = sysdate(),
            <if test="deleteMark != null">
                delete_mark = #{deleteMark},
            </if>
        </set>
        where order_id = #{orderId}
    </update>

</mapper>